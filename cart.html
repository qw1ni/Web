<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/styles.css">
    <title>Sneaker Store - Cart</title>
    <style>
        .cart-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--color-dark);
        }
        
        .cart-header {
            background: transparent;
            color: var(--color-light);
            padding: 40px;
            border-radius: var(--border-radius);
            border: var(--border);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .cart-header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
        }
        
        .cart-header p {
            font-size: 1.2em;
            opacity: 0.9;
            margin: 0;
        }
        
        .cart-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }
        
        .cart-main {
            background: transparent;
            border-radius: var(--border-radius);
            border: var(--border);
            overflow: hidden;
        }
        
        .cart-items {
            padding: 0;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 25px;
            border-bottom: var(--border);
            transition: all 0.3s ease;
        }
        
        .cart-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .item-image {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            flex-shrink: 0;
        }
        
        .item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .item-details {
            flex: 1;
            margin-right: 20px;
        }
        
        .item-brand {
            color: var(--color-light);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            opacity: 0.7;
        }
        
        .item-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--color-light);
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .item-options {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .item-option {
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            color: var(--color-light);
            opacity: 0.8;
        }
        
        .item-price {
            font-size: 20px;
            font-weight: bold;
            color: var(--color-light);
        }
        
        .item-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 35px;
            height: 35px;
            border: var(--border);
            background: transparent;
            color: var(--color-light);
            cursor: pointer;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .quantity-btn:hover:not(:disabled) {
            background: var(--color-accent);
            border-color: var(--color-accent);
        }
        
        .quantity-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 60px;
            height: 35px;
            border: var(--border);
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            background: transparent;
            color: var(--color-light);
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: transparent;
            color: var(--color-light);
        }
        
        .btn-remove {
            background: var(--color-accent);
            color: var(--color-light);
            border-color: var(--color-accent);
        }
        
        .btn-remove:hover {
            opacity: 0.9;
        }
        
        .cart-sidebar {
            background: transparent;
            border-radius: var(--border-radius);
            border: var(--border);
            padding: 25px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .sidebar-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--color-light);
            border-bottom: var(--border);
            padding-bottom: 10px;
        }
        
        .order-summary {
            margin-bottom: 25px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
        }
        
        .summary-row.total {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-light);
            border-top: var(--border);
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .summary-label {
            color: var(--color-light);
            opacity: 0.8;
        }
        
        .summary-value {
            color: var(--color-light);
            font-weight: 500;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: var(--color-accent);
            color: var(--color-light);
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .checkout-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .checkout-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }
        
        .secondary-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: var(--color-light);
            border: var(--border);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .secondary-btn:hover {
            border-color: var(--color-accent);
        }
        
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-light);
        }
        
        .empty-cart h3 {
            margin-bottom: 15px;
            color: var(--color-light);
            font-size: 1.5em;
        }
        
        .empty-cart p {
            margin-bottom: 25px;
            font-size: 1.1em;
            opacity: 0.8;
        }
        
        .empty-cart-btn {
            display: inline-block;
            padding: 12px 30px;
            background: var(--color-accent);
            color: var(--color-light);
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .empty-cart-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--color-light);
            font-size: 18px;
            opacity: 0.7;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            color: var(--color-accent);
        }
        
        .error h3 {
            margin-bottom: 10px;
            color: var(--color-light);
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 1024px) {
            .cart-layout {
                grid-template-columns: 1fr;
            }
            
            .cart-sidebar {
                position: static;
                margin-top: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .cart-container {
                padding: 10px;
            }
            
            .cart-header {
                padding: 30px 20px;
            }
            
            .cart-header h1 {
                font-size: 2em;
            }
            
            .cart-item {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .item-image {
                width: 100%;
                height: 200px;
                margin-right: 0;
            }
            
            .item-details {
                margin-right: 0;
            }
            
            .item-controls {
                flex-direction: row;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div data-include="header"></div>

    <main class="content">
        <div class="cart-container">
            <div class="cart-header">
                <h1 data-i18n="cart.page.title">üõí Shopping Cart</h1>
                <p data-i18n="cart.page.subtitle">Review your items before checkout</p>
            </div>

            <div class="cart-layout">
                <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∫–æ—Ä–∑–∏–Ω—ã -->
                <main class="cart-main">
                    <div id="cart-content">
                        <div class="loading" data-i18n="cart.loading">Loading cart...</div>
                    </div>
                </main>

                <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏—Ç–æ–≥–∞–º–∏ -->
                <aside class="cart-sidebar">
                    <h2 class="sidebar-title" data-i18n="cart.summary.title">Order summary</h2>
                    
                    <div class="order-summary" id="order-summary">
                        <div class="summary-row">
                            <span class="summary-label" data-i18n="cart.summary.items">Items:</span>
                            <span class="summary-value" id="items-count">0 items</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label" data-i18n="cart.summary.subtotal">Subtotal:</span>
                            <span class="summary-value" id="subtotal">$0.00</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label" data-i18n="cart.summary.shipping">Shipping:</span>
                            <span class="summary-value" id="shipping" data-i18n="cart.summary.free">Free</span>
                        </div>
                        <div class="summary-row total">
                            <span class="summary-label" data-i18n="cart.summary.total">Total:</span>
                            <span class="summary-value" id="total">$0.00</span>
                        </div>
                    </div>

                    <button class="checkout-btn" id="checkout-btn" disabled data-i18n="cart.buttons.checkout">
                        Checkout
                    </button>
                    
                    <button class="secondary-btn" onclick="continueShopping()" data-i18n="cart.buttons.continue">
                        Continue shopping
                    </button>
                    
                    <button class="secondary-btn" onclick="clearCart()" id="clear-cart-btn" style="display: none;" data-i18n="cart.buttons.clear">
                        Clear cart
                    </button>
                </aside>
            </div>
        </div>
    </main>

    <div data-include="footer"></div>

    <script src="./scripts/partials.js"></script>
    <script src="./scripts/i18n.js"></script>
    <script src="./scripts/api.js"></script>
    <script src="./scripts/cart.js"></script>
    <script src="./scripts/accessibility.js"></script>
    <script src="./scripts/modal.js"></script>
    
    <script>
        const cartFallbacks = {
            'cart.page.title': 'üõí Shopping Cart',
            'cart.page.subtitle': 'Review your items before checkout',
            'cart.loading': 'Loading cart...',
            'cart.summary.title': 'Order summary',
            'cart.summary.items': 'Items:',
            'cart.summary.subtotal': 'Subtotal:',
            'cart.summary.shipping': 'Shipping:',
            'cart.summary.total': 'Total:',
            'cart.summary.itemsValue': '{count} items',
            'cart.summary.free': 'Free',
            'cart.buttons.checkout': 'Checkout',
            'cart.buttons.continue': 'Continue shopping',
            'cart.buttons.clear': 'Clear cart',
            'cart.empty.title': 'Your cart is empty',
            'cart.empty.text': 'Add items from the catalog to place an order.',
            'cart.empty.button': 'Browse catalog',
            'cart.item.size': 'Size: {value}',
            'cart.item.color': 'Color: {value}',
            'cart.item.remove': 'üóëÔ∏è Remove',
            'cart.alerts.wishlistAdded': 'Item added to wishlist!',
            'cart.messages.quantityUpdated': 'Quantity updated',
            'cart.errors.quantityUpdate': 'Failed to update quantity',
            'cart.modal.removeQuestion': 'Remove item from cart?',
            'cart.modal.removeTitle': 'Remove item',
            'cart.modal.removeConfirm': 'Remove',
            'cart.modal.cancel': 'Cancel',
            'cart.messages.itemRemoved': 'Item removed from cart',
            'cart.errors.itemRemove': 'Failed to remove item',
            'cart.modal.clearQuestion': 'Clear the entire cart? This action cannot be undone.',
            'cart.modal.clearTitle': 'Clear cart',
            'cart.modal.clearConfirm': 'Clear',
            'cart.messages.cartCleared': 'Cart cleared',
            'cart.errors.cartClear': 'Failed to clear cart',
            'cart.messages.checkoutProcessing': 'Processing order...',
            'cart.alerts.empty': 'Your cart is empty',
            'cart.confirm.loginRequired': 'You need to sign in to place an order. Go to the login page?',
            'cart.errors.load': 'Failed to load cart: {reason}',
            'cart.errors.loadTitle': 'Error',
            'cart.errors.checkout': 'Failed to place order: {reason}',
            'cart.order.paymentMethod': 'Cash on delivery',
            'cart.receipt.title': 'Order placed!',
            'cart.receipt.orderNumber': 'Order number: #{id}',
            'cart.receipt.customerSection': 'Customer details',
            'cart.receipt.itemsSection': 'Order items',
            'cart.receipt.customer.phone': 'Phone',
            'cart.receipt.customer.address': 'Shipping address',
            'cart.receipt.table.product': 'Product',
            'cart.receipt.table.size': 'Size',
            'cart.receipt.table.quantity': 'Qty',
            'cart.receipt.table.price': 'Price',
            'cart.receipt.table.subtotal': 'Subtotal',
            'cart.receipt.summary.subtotal': 'Subtotal:',
            'cart.receipt.summary.tax': 'Tax (10%):',
            'cart.receipt.summary.shipping': 'Shipping:',
            'cart.receipt.summary.total': 'Total:',
            'cart.receipt.paymentMethod': 'Payment method:',
            'cart.receipt.status': 'Status:',
            'cart.receipt.statusValue': 'Processing',
            'cart.receipt.thankYou': 'Thank you for your purchase! We will send a confirmation to your email.',
            'cart.receipt.close': 'Close',
            'cart.receipt.continueShopping': 'Continue shopping'
        };

        function t(key, replacements = {}) {
            const translateFn = window.I18n && typeof window.I18n.translate === 'function'
                ? window.I18n.translate
                : () => key;
            let result = translateFn(key);
            if (result === key && cartFallbacks[key]) {
                result = cartFallbacks[key];
            }
            result = String(result);
            Object.entries(replacements).forEach(([placeholder, value]) => {
                result = result.replace(`{${placeholder}}`, value);
            });
            return result;
        }

        function getCurrentLanguage() {
            return window.I18n && typeof window.I18n.getCurrentLanguage === 'function'
                ? window.I18n.getCurrentLanguage()
                : 'en';
        }

        function formatCurrency(value) {
            const amount = Number(value) || 0;
            const language = getCurrentLanguage();
            const locale = language === 'ru' ? 'ru-RU' : 'en-US';

            try {
                return new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                }).format(amount);
            } catch (error) {
                console.warn('Currency formatting failed, falling back to USD string.', error);
                return `$${amount.toFixed(2)}`;
            }
        }

        const cartState = {
            cart: null
        };

        const preloader = {
            start: async () => { console.log('Loading cart...'); },
            stop: async () => { console.log('Cart loading complete'); },
            showMessage: (message, duration, type) => {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = message;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 25px;
                    background: ${type === 'error' ? '#f8d7da' : '#d4edda'};
                    color: ${type === 'error' ? '#721c24' : '#155724'};
                    border: 1px solid ${type === 'error' ? '#f5c6cb' : '#c3e6cb'};
                    border-radius: 8px;
                    z-index: 10000;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
                    animation: slideIn 0.3s ease-out;
                `;
                document.body.appendChild(messageDiv);
                setTimeout(() => {
                    messageDiv.style.animation = 'fadeOut 0.2s ease-out';
                    messageDiv.addEventListener('animationend', () => messageDiv.remove());
                }, duration || 3000);
            }
        };

        if (!window.SneakerStoreCart) {
            console.error('SneakerStoreCart not initialized. Make sure cart.js is loaded.');
        }

        window.SneakerStoreApp = {
            addToWishlist: async () => {
                alert(t('cart.alerts.wishlistAdded'));
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCart();
            setupEventListeners();
        });

        document.addEventListener('languageChanged', () => {
            renderCart();
        });

        async function loadCart() {
            try {
                const cart = window.SneakerStoreCart.getCart();
                cartState.cart = cart;
                renderCart();
            } catch (error) {
                console.error('Failed to load cart:', error);
                showError('cart.errors.load', { reason: error.message });
            }
        }

        function renderCart() {
            const cart = cartState.cart || { items: [], total: 0, itemCount: 0 };
            displayCart(cart);
            updateOrderSummary(cart);
        }

        function displayCart(cart) {
            cartState.cart = cart;
            const container = document.getElementById('cart-content');

            if (!container) {
                return;
            }

            if (!cart.items || cart.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <h3>${t('cart.empty.title')}</h3>
                        <p>${t('cart.empty.text')}</p>
                        <a href="catalog.html" class="empty-cart-btn">${t('cart.empty.button')}</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="cart-items">
                    ${cart.items.map(item => createCartItemHTML(item)).join('')}
                </div>
            `;
        }

        function createCartItemHTML(item) {
            const product = item.product || {
                name: `Product ${item.productId}`,
                brand: 'Brand',
                image: './images/catalogItem1.svg',
                stockQuantity: 999
            };

            const itemId = item.id || item.productId;
            const stock = product.stockQuantity ?? 999;

            return `
                <div class="cart-item" data-item-id="${itemId}">
                    <div class="item-image">
                        <img src="${product.image}" alt="${product.name}" loading="lazy">
                    </div>

                    <div class="item-details">
                        <div class="item-brand">${product.brand}</div>
                        <h3 class="item-name">${product.name}</h3>
                        <div class="item-options">
                            <span class="item-option">${t('cart.item.size', { value: item.size })}</span>
                            <span class="item-option">${t('cart.item.color', { value: item.color })}</span>
                        </div>
                        <div class="item-price">${formatCurrency(item.price)}</div>
                    </div>

                    <div class="item-controls">
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity('${itemId}', ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="${stock}" onchange="updateQuantity('${itemId}', parseInt(this.value, 10))">
                            <button class="quantity-btn" onclick="updateQuantity('${itemId}', ${item.quantity + 1})" ${item.quantity >= stock ? 'disabled' : ''}>+</button>
                        </div>

                        <div class="item-actions">
                            <button class="action-btn btn-remove" onclick="removeItem('${itemId}')">${t('cart.item.remove')}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateOrderSummary(cart) {
            const itemCountEl = document.getElementById('items-count');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');
            const shippingEl = document.getElementById('shipping');
            const checkoutBtn = document.getElementById('checkout-btn');
            const clearBtn = document.getElementById('clear-cart-btn');

            if (!itemCountEl || !subtotalEl || !totalEl || !shippingEl || !checkoutBtn || !clearBtn) {
                return;
            }

            const shippingCost = cart.total > 100 ? 0 : 10;

            itemCountEl.textContent = t('cart.summary.itemsValue', { count: cart.itemCount || 0 });
            subtotalEl.textContent = formatCurrency(cart.total || 0);
            totalEl.textContent = formatCurrency((cart.total || 0));
            shippingEl.textContent = shippingCost === 0 ? t('cart.summary.free') : formatCurrency(shippingCost);

            if (cart.items && cart.items.length > 0) {
                checkoutBtn.disabled = false;
                clearBtn.style.display = 'block';
            } else {
                checkoutBtn.disabled = true;
                clearBtn.style.display = 'none';
            }

            const counter = document.getElementById('cart-count');
            if (counter) {
                counter.textContent = cart.itemCount || 0;
                counter.style.display = (cart.itemCount || 0) > 0 ? 'flex' : 'none';
            }
        }

        async function updateQuantity(itemId, newQuantity) {
            if (!itemId || Number.isNaN(newQuantity) || newQuantity < 1) {
                return;
            }

            try {
                await preloader.start();
                const result = await window.SneakerStoreCart.updateQuantity(itemId, newQuantity);
                await preloader.stop();

                if (result.success) {
                    const cart = window.SneakerStoreCart.getCart();
                    cartState.cart = cart;
                    renderCart();
                    preloader.showMessage(t('cart.messages.quantityUpdated'), 2000);
                } else {
                    preloader.showMessage(result.error || t('cart.errors.quantityUpdate'), 3000, 'error');
                }
            } catch (error) {
                await preloader.stop();
                preloader.showMessage(t('cart.errors.quantityUpdate'), 3000, 'error');
            }
        }

        async function removeItem(itemId) {
            if (!itemId) return;

            const confirmRemoval = async () => {
                try {
                    await preloader.start();
                    const result = await window.SneakerStoreCart.removeItem(itemId);
                    await preloader.stop();

                    if (result.success) {
                        const cart = window.SneakerStoreCart.getCart();
                        cartState.cart = cart;
                        renderCart();
                        if (window.ModalManager) {
                            window.ModalManager.showNotification(t('cart.messages.itemRemoved'), 'success');
                        } else {
                            preloader.showMessage(t('cart.messages.itemRemoved'), 2000);
                        }
                    } else {
                        const errorMessage = result.error || t('cart.errors.itemRemove');
                        if (window.ModalManager) {
                            window.ModalManager.showNotification(errorMessage, 'error');
                        } else {
                            preloader.showMessage(errorMessage, 3000, 'error');
                        }
                    }
                } catch (error) {
                    await preloader.stop();
                    console.error('Failed to remove cart item:', error);
                    const message = t('cart.errors.itemRemove');
                    if (window.ModalManager) {
                        window.ModalManager.showNotification(message, 'error');
                    } else {
                        preloader.showMessage(message, 3000, 'error');
                    }
                }
            };

            if (window.ModalManager && typeof window.ModalManager.showConfirmation === 'function') {
                window.ModalManager.showConfirmation(t('cart.modal.removeQuestion'), {
                    title: t('cart.modal.removeTitle'),
                    confirmText: t('cart.modal.removeConfirm'),
                    cancelText: t('cart.modal.cancel'),
                    onConfirm: confirmRemoval
                });
            } else {
                if (confirm(t('cart.modal.removeQuestion'))) {
                    await confirmRemoval();
                }
            }
        }

        async function clearCart() {
            const confirmClear = async () => {
                try {
                    await preloader.start();
                    const result = await window.SneakerStoreCart.clearCart();
                    await preloader.stop();

                    if (result.success) {
                        cartState.cart = { items: [], total: 0, itemCount: 0 };
                        renderCart();
                        if (window.ModalManager) {
                            window.ModalManager.showNotification(t('cart.messages.cartCleared'), 'success');
                        } else {
                            preloader.showMessage(t('cart.messages.cartCleared'), 2000);
                        }
                    } else {
                        const errorMessage = result.error || t('cart.errors.cartClear');
                        if (window.ModalManager) {
                            window.ModalManager.showNotification(errorMessage, 'error');
                        } else {
                            preloader.showMessage(errorMessage, 3000, 'error');
                        }
                    }
                } catch (error) {
                    await preloader.stop();
                    const message = t('cart.errors.cartClear');
                    if (window.ModalManager) {
                        window.ModalManager.showNotification(message, 'error');
                    } else {
                        preloader.showMessage(message, 3000, 'error');
                    }
                }
            };

            if (window.ModalManager && typeof window.ModalManager.showConfirmation === 'function') {
                window.ModalManager.showConfirmation(t('cart.modal.clearQuestion'), {
                    title: t('cart.modal.clearTitle'),
                    confirmText: t('cart.modal.clearConfirm'),
                    cancelText: t('cart.modal.cancel'),
                    onConfirm: confirmClear
                });
            } else {
                if (confirm(t('cart.modal.clearQuestion'))) {
                    await confirmClear();
                }
            }
        }

        function continueShopping() {
            window.location.href = 'catalog.html';
        }

        async function checkout() {
            try {
                const preloaderInstance = window.SneakerStorePreloader?.preloader;
                if (preloaderInstance && typeof preloaderInstance.showMessage === 'function') {
                    await preloaderInstance.showMessage(t('cart.messages.checkoutProcessing'), 1000);
                }

                const cart = window.SneakerStoreCart.getCart();
                if (!cart.items || cart.items.length === 0) {
                    alert(t('cart.alerts.empty'));
                    return;
                }

                const authManager = window.SneakerStoreAuth?.authManager;
                if (!authManager || !authManager.isAuthenticated()) {
                    if (confirm(t('cart.confirm.loginRequired'))) {
                        window.location.href = 'login.html';
                    }
                    return;
                }

                const user = authManager.getCurrentUser();
                const shippingCost = cart.total > 100 ? 0 : 10;
                const tax = cart.total * 0.1;

                const orderData = {
                    userId: user.id,
                    customerInfo: {
                        firstName: user.firstName,
                        lastName: user.lastName,
                        email: user.email,
                        phone: user.phone,
                        address: user.address
                    },
                    items: cart.items.map(item => ({
                        productId: item.productId,
                        productName: item.product.name,
                        brand: item.product.brand,
                        size: item.size,
                        color: item.color,
                        quantity: item.quantity,
                        price: item.price,
                        subtotal: item.price * item.quantity
                    })),
                    subtotal: cart.total,
                    tax,
                    shipping: shippingCost,
                    total: cart.total + tax + shippingCost,
                    status: 'pending',
                    paymentMethod: t('cart.order.paymentMethod'),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const apiClient = new SneakerStoreAPI.ApiClient();
                const response = await apiClient.post('/orders', orderData);

                if (response.success) {
                    const order = response.data;
                    showOrderReceipt(order);
                    await window.SneakerStoreCart.clearCart();
                    cartState.cart = { items: [], total: 0, itemCount: 0 };
                    renderCart();
                } else {
                    throw new Error(response.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Checkout failed:', error);
                alert(t('cart.errors.checkout', { reason: error.message }));
            }
        }

        function showOrderReceipt(order) {
            const shippingValue = order.shipping === 0 ? t('cart.summary.free') : formatCurrency(order.shipping);

            const receiptHTML = `
                <div class="receipt-modal">
                    <div class="receipt-content">
                        <div class="receipt-header">
                            <div class="receipt-icon">‚úÖ</div>
                            <h2>${t('cart.receipt.title')}</h2>
                            <p class="receipt-order-number">${t('cart.receipt.orderNumber', { id: order.id })}</p>
                        </div>

                        <div class="receipt-customer">
                            <h3>${t('cart.receipt.customerSection')}</h3>
                            <p><strong>${order.customerInfo.firstName} ${order.customerInfo.lastName}</strong></p>
                            <p>Email: ${order.customerInfo.email}</p>
                            <p>${t('cart.receipt.customer.phone')}: ${order.customerInfo.phone || '-'}</p>
                            <p>${t('cart.receipt.customer.address')}: ${formatAddress(order.customerInfo.address)}</p>
                        </div>

                        <div class="receipt-items">
                            <h3>${t('cart.receipt.itemsSection')}</h3>
                            <table class="receipt-table">
                                <thead>
                                    <tr>
                                        <th>${t('cart.receipt.table.product')}</th>
                                        <th>${t('cart.receipt.table.size')}</th>
                                        <th>${t('cart.receipt.table.quantity')}</th>
                                        <th>${t('cart.receipt.table.price')}</th>
                                        <th>${t('cart.receipt.table.subtotal')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => `
                                        <tr>
                                            <td>
                                                <strong>${item.productName}</strong><br>
                                                <small>${item.brand || ''}</small>
                                            </td>
                                            <td>${item.size}</td>
                                            <td>${item.quantity}</td>
                                            <td>${formatCurrency(item.price)}</td>
                                            <td>${formatCurrency(item.subtotal)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="receipt-summary">
                            <div class="receipt-row">
                                <span>${t('cart.receipt.summary.subtotal')}</span>
                                <span>${formatCurrency(order.subtotal)}</span>
                            </div>
                            <div class="receipt-row">
                                <span>${t('cart.receipt.summary.tax')}</span>
                                <span>${formatCurrency(order.tax)}</span>
                            </div>
                            <div class="receipt-row">
                                <span>${t('cart.receipt.summary.shipping')}</span>
                                <span>${shippingValue}</span>
                            </div>
                            <div class="receipt-row receipt-total">
                                <span><strong>${t('cart.receipt.summary.total')}</strong></span>
                                <span><strong>${formatCurrency(order.total)}</strong></span>
                            </div>
                        </div>

                        <div class="receipt-payment">
                            <p><strong>${t('cart.receipt.paymentMethod')}</strong> ${order.paymentMethod}</p>
                            <p><strong>${t('cart.receipt.status')}</strong> ${t('cart.receipt.statusValue')}</p>
                        </div>

                        <div class="receipt-footer">
                            <p>${t('cart.receipt.thankYou')}</p>
                            <button class="btn-primary" onclick="closeReceipt()">${t('cart.receipt.close')}</button>
                            <button class="btn-secondary" onclick="window.location.href='catalog.html'">${t('cart.receipt.continueShopping')}</button>
                        </div>
                    </div>
                </div>
            `;

            const style = document.createElement('style');
            style.textContent = `
                .receipt-modal {
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s ease;
                }

                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }

                .receipt-content {
                    background: #fff;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 640px;
                    max-height: 90vh;
                    overflow-y: auto;
                    animation: slideIn 0.3s ease;
                }

                @keyframes slideIn {
                    from { transform: translateY(-30px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }

                .receipt-header {
                    text-align: center;
                    margin-bottom: 24px;
                }

                .receipt-icon {
                    font-size: 60px;
                    margin-bottom: 12px;
                }

                .receipt-order-number {
                    color: #666;
                    font-size: 14px;
                }

                .receipt-customer,
                .receipt-items,
                .receipt-summary,
                .receipt-payment {
                    margin-bottom: 24px;
                    padding-bottom: 18px;
                    border-bottom: 1px dashed #ddd;
                }

                .receipt-table {
                    width: 100%;
                    border-collapse: collapse;
                }

                .receipt-table th,
                .receipt-table td {
                    padding: 10px;
                    border-bottom: 1px solid #eee;
                    text-align: left;
                }

                .receipt-summary {
                    background: #f8f9fa;
                    border-radius: 12px;
                    padding: 18px;
                }

                .receipt-row {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 6px 0;
                }

                .receipt-total {
                    border-top: 2px solid #333;
                    margin-top: 10px;
                    padding-top: 14px;
                    font-size: 1.2em;
                    color: #28a745;
                }

                .receipt-footer {
                    text-align: center;
                }

                .receipt-footer button {
                    margin: 5px;
                    padding: 12px 28px;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    transition: all 0.2s ease;
                }

                .btn-primary {
                    background: var(--color-accent, #28a745);
                    color: #fff;
                }

                .btn-secondary {
                    background: #6c757d;
                    color: #fff;
                }

                .btn-primary:hover,
                .btn-secondary:hover {
                    opacity: 0.9;
                    transform: translateY(-2px);
                }

                @media (max-width: 768px) {
                    .receipt-content {
                        padding: 20px;
                        max-width: 95vw;
                    }

                    .receipt-table {
                        font-size: 12px;
                    }
                }
            `;
            document.head.appendChild(style);

            const receiptContainer = document.createElement('div');
            receiptContainer.id = 'order-receipt';
            receiptContainer.innerHTML = receiptHTML;
            document.body.appendChild(receiptContainer);
        }

        function formatAddress(address) {
            if (!address || typeof address !== 'object') {
                return '-';
            }

            const parts = [address.street, address.city, address.state, address.zipCode, address.country]
                .filter(Boolean)
                .map(part => String(part).trim())
                .filter(part => part.length > 0);

            return parts.length ? parts.join(', ') : '-';
        }

        function closeReceipt() {
            const receipt = document.getElementById('order-receipt');
            if (receipt) {
                receipt.style.animation = 'fadeOut 0.2s ease';
                setTimeout(() => {
                    receipt.remove();
                    window.location.reload();
                }, 200);
            }
        }

        function setupEventListeners() {
            if (window.SneakerStoreCart && typeof window.SneakerStoreCart.subscribe === 'function') {
                window.SneakerStoreCart.subscribe(cart => {
                    cartState.cart = cart;
                    renderCart();
                });
            }

            const checkoutBtn = document.getElementById('checkout-btn');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', checkout);
            }
        }

        function showError(key, replacements = {}) {
            const container = document.getElementById('cart-content');
            if (!container) return;

            container.innerHTML = `
                <div class="error">
                    <h3>${t('cart.errors.loadTitle')}</h3>
                    <p>${t(key, replacements)}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
