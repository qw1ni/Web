<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/styles.css">
    <title>Sneaker Store - Profile</title>
    <style>
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .profile-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .info-label {
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }
        .info-value {
            color: #333;
            font-size: 1.1em;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div data-include="header"></div>

    <main class="content">
        <div class="profile-container">
            <div class="profile-header">
                <h1>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>
                <div id="profile-user-info"></div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="profile-section">
                <h2 class="section-title">üìã –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <div id="user-info-loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</div>
                <div id="user-info-error" class="error" style="display: none;"></div>
                <div class="profile-info" id="user-info" style="display: none;">
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="profile-section">
                <h2 class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div id="user-stats-loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
                <div id="user-stats-error" class="error" style="display: none;"></div>
                <div class="profile-info" id="user-stats" style="display: none;">
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="profile-section">
                <h2 class="section-title">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è</h2>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="editProfile()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    <button class="btn btn-primary" onclick="viewOrders()">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>
                    <button class="btn btn-primary" onclick="viewWishlist()">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                    <button class="btn btn-danger" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
                </div>
            </div>
        </div>
    </main>

    <div data-include="footer"></div>

    <script src="./scripts/partials.js"></script>
    <script src="./scripts/main.js"></script>
    <script src="./scripts/api.js"></script>
    <script src="./scripts/preloader.js"></script>
    <script src="./scripts/auth.js"></script>
    <script src="./scripts/cart.js"></script>
    
    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            if (!window.SneakerStoreAuth || !window.SneakerStoreAuth.authManager.isAuthenticated()) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                window.location.href = '/login.html';
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            await loadProfileData();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
        async function loadProfileData() {
            try {
                await Promise.all([
                    loadUserInfo(),
                    loadUserStats()
                ]);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        async function loadUserInfo() {
            try {
                const authManager = window.SneakerStoreAuth.authManager;
                const user = authManager.getCurrentUser();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                document.getElementById('profile-user-info').innerHTML = `
                    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.firstName} ${user.lastName}!</p>
                    <p>–†–æ–ª—å: <span style="text-transform: capitalize;">${user.role}</span></p>
                `;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                displayUserInfo(user);
                
            } catch (error) {
                showError('user-info-error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: ' + error.message);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function displayUserInfo(user) {
            const container = document.getElementById('user-info');
            container.innerHTML = `
                <div class="info-item">
                    <div class="info-label">–ò–º—è</div>
                    <div class="info-value">${user.firstName} ${user.lastName}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">${user.email}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                    <div class="info-value">${user.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–†–æ–ª—å</div>
                    <div class="info-value" style="text-transform: capitalize;">${user.role}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                    <div class="info-value">${new Date(user.createdAt).toLocaleDateString()}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</div>
                    <div class="info-value">${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : '–ù–∏–∫–æ–≥–¥–∞'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ê–¥—Ä–µ—Å</div>
                    <div class="info-value">
                        ${user.address.street ? user.address.street + ', ' : ''}
                        ${user.address.city ? user.address.city + ', ' : ''}
                        ${user.address.state ? user.address.state + ' ' : ''}
                        ${user.address.zipCode ? user.address.zipCode + ', ' : ''}
                        ${user.address.country || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </div>
                </div>
            `;
            
            document.getElementById('user-info-loading').style.display = 'none';
            document.getElementById('user-info').style.display = 'grid';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserStats() {
            try {
                const authManager = window.SneakerStoreAuth.authManager;
                const user = authManager.getCurrentUser();
                const apiClient = new SneakerStoreAPI.ApiClient();
                
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–∑–∏–Ω—ã –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const [cartsResponse, wishlistsResponse] = await Promise.all([
                    apiClient.get('/carts', { userId: user.id }),
                    apiClient.get('/wishlists', { userId: user.id })
                ]);
                
                let totalOrders = 0;
                let totalSpent = 0;
                let totalWishlistItems = 0;
                
                if (cartsResponse.success && cartsResponse.data) {
                    totalOrders = cartsResponse.data.length;
                    totalSpent = cartsResponse.data.reduce((sum, cart) => sum + cart.total, 0);
                }
                
                if (wishlistsResponse.success && wishlistsResponse.data && wishlistsResponse.data.length > 0) {
                    totalWishlistItems = wishlistsResponse.data[0].items.length;
                }
                
                displayUserStats({
                    totalOrders,
                    totalSpent,
                    totalWishlistItems,
                    memberSince: new Date(user.createdAt).getFullYear()
                });
                
            } catch (error) {
                showError('user-stats-error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function displayUserStats(stats) {
            const container = document.getElementById('user-stats');
            container.innerHTML = `
                <div class="info-item">
                    <div class="info-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                    <div class="info-value">${stats.totalOrders}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                    <div class="info-value">$${stats.totalSpent}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º</div>
                    <div class="info-value">${stats.totalWishlistItems} —Ç–æ–≤–∞—Ä–æ–≤</div>
                </div>
                <div class="info-item">
                    <div class="info-label">–£—á–∞—Å—Ç–Ω–∏–∫ —Å</div>
                    <div class="info-value">${stats.memberSince} –≥–æ–¥–∞</div>
                </div>
            `;
            
            document.getElementById('user-stats-loading').style.display = 'none';
            document.getElementById('user-stats').style.display = 'grid';
        }

        // –î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function editProfile() {
            alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
        }

        function viewOrders() {
            alert('–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤ (—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
        }

        function viewWishlist() {
            alert('–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
        }

        function logout() {
            if (window.SneakerStoreAuth && window.SneakerStoreAuth.authManager) {
                window.SneakerStoreAuth.authManager.logout();
            }
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–æ–∫
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    </script>
</body>
</html>
