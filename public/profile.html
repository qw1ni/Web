<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/styles.css">
    <title>Sneaker Store - Profile</title>
    <style>
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .profile-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .info-label {
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }
        .info-value {
            color: #333;
            font-size: 1.1em;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div data-include="header"></div>

    <main class="content">
        <div class="profile-container">
            <div class="profile-header">
                <h1 data-i18n="profile.title">üë§ User Profile</h1>
                <div id="profile-user-info"></div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="profile-section">
                <h2 class="section-title" data-i18n="profile.sections.info">üìã Personal Information</h2>
                <div id="user-info-loading" class="loading" data-i18n="profile.loading.info">Loading information...</div>
                <div id="user-info-error" class="error" style="display: none;"></div>
                <div class="profile-info" id="user-info" style="display: none;">
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="profile-section">
                <h2 class="section-title" data-i18n="profile.sections.stats">üìä Statistics</h2>
                <div id="user-stats-loading" class="loading" data-i18n="profile.loading.stats">Loading statistics...</div>
                <div id="user-stats-error" class="error" style="display: none;"></div>
                <div class="profile-info" id="user-stats" style="display: none;">
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="profile-section">
                <h2 class="section-title" data-i18n="profile.sections.actions">‚öôÔ∏è Actions</h2>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="editProfile()" data-i18n="profile.buttons.edit">Edit profile</button>
                    <button class="btn btn-primary" onclick="viewOrders()" data-i18n="profile.buttons.orders">My orders</button>
                    <button class="btn btn-primary" onclick="viewWishlist()" data-i18n="profile.buttons.wishlist">Wishlist</button>
                    <button class="btn btn-danger" onclick="logout()" data-i18n="profile.buttons.logout">Sign out</button>
                </div>
            </div>
        </div>
    </main>

    <div data-include="footer"></div>

    <script src="./scripts/partials.js"></script>
    <script src="./scripts/i18n.js"></script>
    <script src="./scripts/main.js"></script>
    <script src="./scripts/api.js"></script>
    <script src="./scripts/preloader.js"></script>
    <script src="./scripts/auth.js"></script>
    <script src="./scripts/cart.js"></script>
    
    <script>
        const profileFallbacks = {
            'profile.messages.loginRequired': 'Authentication required',
            'profile.messages.welcome': 'Welcome, {name}!',
            'profile.messages.role': 'Role: {role}',
            'profile.values.notProvided': 'Not provided',
            'profile.values.never': 'Never',
            'profile.labels.name': 'Name',
            'profile.labels.email': 'Email',
            'profile.labels.phone': 'Phone',
            'profile.labels.role': 'Role',
            'profile.labels.registered': 'Member since',
            'profile.labels.lastLogin': 'Last login',
            'profile.labels.address': 'Address',
            'profile.stats.orders': 'Total orders',
            'profile.stats.spent': 'Total spent',
            'profile.stats.wishlist': 'Wishlist items',
            'profile.stats.wishlistValue': '{count} items',
            'profile.stats.memberSince': 'Member since',
            'profile.stats.memberSinceValue': '{year}',
            'profile.errors.userInfo': 'Failed to load user information: {reason}',
            'profile.errors.userStats': 'Failed to load statistics: {reason}',
            'profile.errors.general': 'Failed to load profile data: {reason}',
            'profile.errors.apiUnavailable': 'The API client is unavailable.',
            'profile.alerts.editProfile': 'Profile editing is coming soon.',
            'profile.alerts.orders': 'Order history is coming soon.',
            'profile.alerts.wishlist': 'Wishlist view is coming soon.',
            'profile.roles.customer': 'Customer',
            'profile.roles.manager': 'Manager',
            'profile.roles.admin': 'Admin',
            'profile.roles.unknown': 'User'
        };

        function t(key, replacements = {}) {
            const translateFn = window.I18n && typeof window.I18n.translate === 'function'
                ? window.I18n.translate
                : () => key;
            let result = translateFn(key);
            if (result === key && profileFallbacks[key]) {
                result = profileFallbacks[key];
            }
            result = String(result);
            Object.entries(replacements).forEach(([placeholder, value]) => {
                result = result.replace(`{${placeholder}}`, value);
            });
            return result;
        }

        const profileState = {
            user: null,
            stats: null
        };

        document.addEventListener('DOMContentLoaded', async () => {
            if (!isAuthenticated()) {
                alert(t('profile.messages.loginRequired'));
                window.location.href = './login.html';
                return;
            }

            await loadProfileData();

            if (window.SneakerStorePreloader && window.SneakerStorePreloader.preloader) {
                try {
                    await window.SneakerStorePreloader.preloader.stop();
                } catch (error) {
                    console.warn('Failed to stop preloader:', error);
                }
            }
        });

        document.addEventListener('languageChanged', () => {
            renderProfile();
        });

        function isAuthenticated() {
            return window.SneakerStoreAuth &&
                window.SneakerStoreAuth.authManager &&
                typeof window.SneakerStoreAuth.authManager.isAuthenticated === 'function' &&
                window.SneakerStoreAuth.authManager.isAuthenticated();
        }

        async function loadProfileData() {
            showLoading('user-info-loading');
            showLoading('user-stats-loading');
            hideElement('user-info');
            hideElement('user-stats');
            hideError('user-info-error');
            hideError('user-stats-error');

            await Promise.allSettled([
                loadUserInfo(),
                loadUserStats()
            ]);
        }

        async function loadUserInfo() {
            try {
                const authManager = window.SneakerStoreAuth.authManager;
                const user = authManager.getCurrentUser();
                profileState.user = user;
                renderProfileHeader(user);
                displayUserInfo(user);
            } catch (error) {
                console.error('Failed to load user info:', error);
                profileState.user = null;
                hideLoading('user-info-loading');
                showError('user-info-error', 'profile.errors.userInfo', { reason: error.message });
            }
        }

        async function loadUserStats() {
            try {
                const authManager = window.SneakerStoreAuth.authManager;
                const user = authManager.getCurrentUser();
                const ApiClient = window.SneakerStoreAPI && window.SneakerStoreAPI.ApiClient;
                if (!ApiClient) {
                    throw new Error(t('profile.errors.apiUnavailable'));
                }

                const apiClient = new ApiClient();
                const [cartsResponse, wishlistsResponse] = await Promise.all([
                    apiClient.get('/carts', { userId: user.id }),
                    apiClient.get('/wishlists', { userId: user.id })
                ]);

                let totalOrders = 0;
                let totalSpent = 0;
                let totalWishlistItems = 0;

                if (cartsResponse && cartsResponse.success && Array.isArray(cartsResponse.data)) {
                    totalOrders = cartsResponse.data.length;
                    totalSpent = cartsResponse.data.reduce((sum, cart) => sum + (cart.total || 0), 0);
                }

                if (wishlistsResponse && wishlistsResponse.success && Array.isArray(wishlistsResponse.data) && wishlistsResponse.data[0]) {
                    totalWishlistItems = Array.isArray(wishlistsResponse.data[0].items)
                        ? wishlistsResponse.data[0].items.length
                        : 0;
                }

                profileState.stats = {
                    totalOrders,
                    totalSpent,
                    totalWishlistItems,
                    memberSince: user.createdAt ? new Date(user.createdAt).getFullYear() : null
                };

                displayUserStats(profileState.stats);
            } catch (error) {
                console.error('Failed to load user stats:', error);
                profileState.stats = null;
                hideLoading('user-stats-loading');
                showError('user-stats-error', 'profile.errors.userStats', { reason: error.message });
            }
        }

        function renderProfileHeader(user) {
            const container = document.getElementById('profile-user-info');
            if (!container) return;

            const name = [user.firstName, user.lastName].filter(Boolean).join(' ') || t('profile.values.notProvided');
            const role = translateRole(user.role);

            container.innerHTML = `
                <p>${t('profile.messages.welcome', { name })}</p>
                <p>${t('profile.messages.role', { role })}</p>
            `;
        }

        function displayUserInfo(user) {
            const container = document.getElementById('user-info');
            if (!container) return;

            hideLoading('user-info-loading');

            const fullName = [user.firstName, user.lastName].filter(Boolean).join(' ') || t('profile.values.notProvided');
            const email = user.email || t('profile.values.notProvided');
            const phone = user.phone || t('profile.values.notProvided');
            const role = translateRole(user.role);
            const registered = user.createdAt ? formatDate(user.createdAt) : t('profile.values.notProvided');
            const lastLogin = user.lastLogin ? formatDate(user.lastLogin) : t('profile.values.never');
            const address = formatAddress(user.address);

            const infoItems = [
                { label: t('profile.labels.name'), value: fullName },
                { label: t('profile.labels.email'), value: email },
                { label: t('profile.labels.phone'), value: phone },
                { label: t('profile.labels.role'), value: role },
                { label: t('profile.labels.registered'), value: registered },
                { label: t('profile.labels.lastLogin'), value: lastLogin },
                { label: t('profile.labels.address'), value: address }
            ];

            container.innerHTML = infoItems.map(item => `
                <div class="info-item">
                    <div class="info-label">${item.label}</div>
                    <div class="info-value">${item.value}</div>
                </div>
            `).join('');

            container.style.display = 'grid';
        }

        function displayUserStats(stats) {
            const container = document.getElementById('user-stats');
            if (!container) return;

            hideLoading('user-stats-loading');

            const wishlistValue = t('profile.stats.wishlistValue', { count: stats.totalWishlistItems });
            const memberSinceValue = stats.memberSince !== null
                ? t('profile.stats.memberSinceValue', { year: stats.memberSince })
                : t('profile.values.notProvided');

            const statsItems = [
                { label: t('profile.stats.orders'), value: stats.totalOrders },
                { label: t('profile.stats.spent'), value: formatCurrency(stats.totalSpent) },
                { label: t('profile.stats.wishlist'), value: wishlistValue },
                { label: t('profile.stats.memberSince'), value: memberSinceValue }
            ];

            container.innerHTML = statsItems.map(item => `
                <div class="info-item">
                    <div class="info-label">${item.label}</div>
                    <div class="info-value">${item.value}</div>
                </div>
            `).join('');

            container.style.display = 'grid';
        }

        function formatAddress(address) {
            if (!address || typeof address !== 'object') {
                return t('profile.values.notProvided');
            }

            const parts = [
                address.street,
                address.city,
                address.state,
                address.zipCode,
                address.country
            ].filter(part => part && String(part).trim().length > 0);

            return parts.length > 0 ? parts.join(', ') : t('profile.values.notProvided');
        }

        function formatDate(value) {
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return t('profile.values.notProvided');
            }

            const language = window.I18n && typeof window.I18n.getCurrentLanguage === 'function'
                ? window.I18n.getCurrentLanguage()
                : 'en';

            const locale = language === 'ru' ? 'ru-RU' : 'en-US';

            try {
                return new Intl.DateTimeFormat(locale).format(date);
            } catch (error) {
                console.warn('Date formatting failed, falling back to ISO string.', error);
                return date.toISOString().split('T')[0];
            }
        }

        function formatCurrency(value) {
            const amount = Number(value) || 0;
            const language = window.I18n && typeof window.I18n.getCurrentLanguage === 'function'
                ? window.I18n.getCurrentLanguage()
                : 'en';
            const locale = language === 'ru' ? 'ru-RU' : 'en-US';

            try {
                return new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                }).format(amount);
            } catch (error) {
                console.warn('Currency formatting failed, falling back to USD string.', error);
                return `$${amount.toFixed(2)}`;
            }
        }

        function translateRole(role) {
            const normalized = (role || 'unknown').toLowerCase();
            const key = `profile.roles.${normalized}`;
            const translation = t(key);
            if (translation === key) {
                return normalized.charAt(0).toUpperCase() + normalized.slice(1);
            }
            return translation;
        }

        function showLoading(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
            }
        }

        function hideLoading(id) {
            hideElement(id);
        }

        function hideElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
            }
        }

        function hideError(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
                element.textContent = '';
            }
        }

        function showError(id, key, replacements = {}) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = t(key, replacements);
                element.style.display = 'block';
            }
        }

        function renderProfile() {
            if (profileState.user) {
                renderProfileHeader(profileState.user);
                displayUserInfo(profileState.user);
            }
            if (profileState.stats) {
                displayUserStats(profileState.stats);
            }
        }

        function editProfile() {
            alert(t('profile.alerts.editProfile'));
        }

        function viewOrders() {
            alert(t('profile.alerts.orders'));
        }

        function viewWishlist() {
            alert(t('profile.alerts.wishlist'));
        }

        function logout() {
            if (window.SneakerStoreAuth && window.SneakerStoreAuth.authManager) {
                window.SneakerStoreAuth.authManager.logout();
            }
        }
    </script>
</body>
</html>
