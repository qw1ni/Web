<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/styles.css">
    <title>Sneaker Store - Profile</title>
    <style>
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .profile-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .info-label {
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }
        .info-value {
            color: #333;
            font-size: 1.1em;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .profile-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            padding: 20px;
            transition: opacity 0.15s ease;
            opacity: 0;
        }
        .profile-modal[hidden] {
            display: none;
        }
        .profile-modal.is-open {
            opacity: 1;
        }
        .profile-modal__dialog {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            max-width: 680px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
        }
        .profile-modal__title {
            margin: 0 0 20px 0;
            font-size: 1.5rem;
            color: #333;
        }
        .profile-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .profile-form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .profile-form-field label {
            font-weight: 600;
            color: #333;
        }
        .profile-form-field input,
        .profile-form-field textarea,
        .profile-form-field select {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px;
            font-size: 14px;
            font-family: inherit;
        }
        .profile-form-field textarea {
            resize: vertical;
        }
        .profile-form-field--full {
            grid-column: 1 / -1;
        }
        .profile-modal__actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
        }
        .profile-modal__error {
            flex: 1;
            margin: 0;
            font-size: 14px;
            color: #dc3545;
        }
        body.profile-modal-open {
            overflow: hidden;
        }
        @media (max-width: 768px) {
            .profile-form-grid {
                grid-template-columns: 1fr;
            }
            .profile-modal__dialog {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div data-include="header"></div>

    <main class="content">
        <div class="profile-container">
            <div class="profile-header">
                <h1 data-i18n="profile.title">üë§ User Profile</h1>
                <div id="profile-user-info"></div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="profile-section">
                <h2 class="section-title" data-i18n="profile.sections.info">üìã Personal Information</h2>
                <div id="user-info-loading" class="loading" data-i18n="profile.loading.info">Loading information...</div>
                <div id="user-info-error" class="error" style="display: none;"></div>
                <div class="profile-info" id="user-info" style="display: none;">
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="profile-section">
                <h2 class="section-title" data-i18n="profile.sections.stats">üìä Statistics</h2>
                <div id="user-stats-loading" class="loading" data-i18n="profile.loading.stats">Loading statistics...</div>
                <div id="user-stats-error" class="error" style="display: none;"></div>
                <div class="profile-info" id="user-stats" style="display: none;">
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="profile-section">
                <h2 class="section-title" data-i18n="profile.sections.actions">‚öôÔ∏è Actions</h2>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="editProfile()" data-i18n="profile.buttons.edit">Edit profile</button>
                    <button class="btn btn-danger" onclick="logout()" data-i18n="profile.buttons.logout">Sign out</button>
                </div>
            </div>
        </div>
    </main>

    <div id="profile-modal" class="profile-modal" hidden>
        <div class="profile-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="profile-modal-title">
            <h3 class="profile-modal__title" id="profile-modal-title">Edit profile</h3>
            <form id="profile-form" class="profile-form">
                <input type="hidden" name="userId" id="profile-user-id">
                <div class="profile-form-grid">
                    <div class="profile-form-field">
                        <label for="profile-first-name">First name*</label>
                        <input type="text" id="profile-first-name" name="firstName" required>
                    </div>
                    <div class="profile-form-field">
                        <label for="profile-last-name">Last name*</label>
                        <input type="text" id="profile-last-name" name="lastName" required>
                    </div>
                    <div class="profile-form-field">
                        <label for="profile-email">Email*</label>
                        <input type="email" id="profile-email" name="email" required>
                    </div>
                    <div class="profile-form-field">
                        <label for="profile-phone">Phone</label>
                        <input type="tel" id="profile-phone" name="phone" placeholder="+1-555-0100">
                    </div>
                    <div class="profile-form-field">
                        <label for="profile-street">Street</label>
                        <input type="text" id="profile-street" name="street">
                    </div>
                    <div class="profile-form-field">
                        <label for="profile-city">City</label>
                        <input type="text" id="profile-city" name="city">
                    </div>
                    <div class="profile-form-field">
                        <label for="profile-state">State/Region</label>
                        <input type="text" id="profile-state" name="state">
                    </div>
                    <div class="profile-form-field">
                        <label for="profile-zip">ZIP/Postal code</label>
                        <input type="text" id="profile-zip" name="zipCode">
                    </div>
                    <div class="profile-form-field">
                        <label for="profile-country">Country</label>
                        <input type="text" id="profile-country" name="country" placeholder="USA">
                    </div>
                    <div class="profile-form-field profile-form-field--full">
                        <label for="profile-password">New password</label>
                        <input type="password" id="profile-password" name="password" placeholder="Leave blank to keep current password">
                    </div>
                </div>
                <div class="profile-modal__actions">
                    <p class="profile-modal__error" id="profile-form-error"></p>
                    <button type="button" class="btn btn-secondary" id="profile-modal-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="profile-form-submit">Save changes</button>
                </div>
            </form>
        </div>
    </div>

    <div data-include="footer"></div>

    <script src="./scripts/partials.js"></script>
    <script src="./scripts/i18n.js"></script>
    <script src="./scripts/main.js"></script>
    <script src="./scripts/api.js"></script>
    <script src="./scripts/preloader.js"></script>
    <script src="./scripts/auth.js"></script>
    <script src="./scripts/cart.js"></script>
    
    <script>
        const profileFallbacks = {
            'profile.messages.loginRequired': 'Authentication required',
            'profile.messages.welcome': 'Welcome, {name}!',
            'profile.messages.role': 'Role: {role}',
            'profile.values.notProvided': 'Not provided',
            'profile.values.never': 'Never',
            'profile.labels.name': 'Name',
            'profile.labels.email': 'Email',
            'profile.labels.phone': 'Phone',
            'profile.labels.role': 'Role',
            'profile.labels.registered': 'Member since',
            'profile.labels.lastLogin': 'Last login',
            'profile.labels.address': 'Address',
            'profile.stats.orders': 'Total orders',
            'profile.stats.spent': 'Total spent',
            'profile.stats.wishlist': 'Wishlist items',
            'profile.stats.wishlistValue': '{count} items',
            'profile.stats.memberSince': 'Member since',
            'profile.stats.memberSinceValue': '{year}',
            'profile.errors.userInfo': 'Failed to load user information: {reason}',
            'profile.errors.userStats': 'Failed to load statistics: {reason}',
            'profile.errors.general': 'Failed to load profile data: {reason}',
            'profile.errors.apiUnavailable': 'The API client is unavailable.',
            'profile.errors.updateFailed': 'Failed to update profile: {reason}',
            'profile.alerts.updateSuccess': 'Profile updated successfully.',
            'profile.alerts.orders': 'Order history is coming soon.',
            'profile.alerts.wishlist': 'Wishlist view is coming soon.',
            'profile.forms.validation.required': 'Please fill out required fields.',
            'profile.forms.validation.email': 'Enter a valid email address.',
            'profile.forms.validation.password': 'Password must be at least 8 characters.',
            'profile.roles.customer': 'Customer',
            'profile.roles.manager': 'Manager',
            'profile.roles.admin': 'Admin',
            'profile.roles.unknown': 'User'
        };

        function t(key, replacements = {}) {
            const translateFn = window.I18n && typeof window.I18n.translate === 'function'
                ? window.I18n.translate
                : () => key;
            let result = translateFn(key);
            if (result === key && profileFallbacks[key]) {
                result = profileFallbacks[key];
            }
            result = String(result);
            Object.entries(replacements).forEach(([placeholder, value]) => {
                result = result.replace(`{${placeholder}}`, value);
            });
            return result;
        }

        const profileState = {
            user: null,
            stats: null
        };

        const profileFormState = {
            modal: null,
            form: null,
            submitButton: null,
            errorContainer: null,
            cancelButton: null,
            currentUser: null
        };

        document.addEventListener('DOMContentLoaded', async () => {
            if (!isAuthenticated()) {
                alert(t('profile.messages.loginRequired'));
                window.location.href = './login.html';
                return;
            }

            initializeProfileForm();

            await loadProfileData();

            if (window.SneakerStorePreloader && window.SneakerStorePreloader.preloader) {
                try {
                    await window.SneakerStorePreloader.preloader.stop();
                } catch (error) {
                    console.warn('Failed to stop preloader:', error);
                }
            }
        });

        document.addEventListener('languageChanged', () => {
            renderProfile();
        });

        function isAuthenticated() {
            return window.SneakerStoreAuth &&
                window.SneakerStoreAuth.authManager &&
                typeof window.SneakerStoreAuth.authManager.isAuthenticated === 'function' &&
                window.SneakerStoreAuth.authManager.isAuthenticated();
        }

        async function loadProfileData() {
            showLoading('user-info-loading');
            showLoading('user-stats-loading');
            hideElement('user-info');
            hideElement('user-stats');
            hideError('user-info-error');
            hideError('user-stats-error');

            await Promise.allSettled([
                loadUserInfo(),
                loadUserStats()
            ]);
        }

        async function loadUserInfo() {
            try {
                const authManager = window.SneakerStoreAuth.authManager;
                const user = authManager.getCurrentUser();
                profileState.user = user;
                renderProfileHeader(user);
                displayUserInfo(user);
            } catch (error) {
                console.error('Failed to load user info:', error);
                profileState.user = null;
                hideLoading('user-info-loading');
                showError('user-info-error', 'profile.errors.userInfo', { reason: error.message });
            }
        }

        async function loadUserStats() {
            try {
                const authManager = window.SneakerStoreAuth.authManager;
                const user = authManager.getCurrentUser();
                const ApiClient = window.SneakerStoreAPI && window.SneakerStoreAPI.ApiClient;
                if (!ApiClient) {
                    throw new Error(t('profile.errors.apiUnavailable'));
                }

                const apiClient = new ApiClient();
                const [cartsResponse, wishlistsResponse] = await Promise.all([
                    apiClient.get('/carts', { userId: user.id }),
                    apiClient.get('/wishlists', { userId: user.id })
                ]);

                let totalOrders = 0;
                let totalSpent = 0;
                let totalWishlistItems = 0;

                if (cartsResponse && cartsResponse.success && Array.isArray(cartsResponse.data)) {
                    totalOrders = cartsResponse.data.length;
                    totalSpent = cartsResponse.data.reduce((sum, cart) => sum + (cart.total || 0), 0);
                }

                if (wishlistsResponse && wishlistsResponse.success && Array.isArray(wishlistsResponse.data) && wishlistsResponse.data[0]) {
                    totalWishlistItems = Array.isArray(wishlistsResponse.data[0].items)
                        ? wishlistsResponse.data[0].items.length
                        : 0;
                }

                profileState.stats = {
                    totalOrders,
                    totalSpent,
                    totalWishlistItems,
                    memberSince: user.createdAt ? new Date(user.createdAt).getFullYear() : null
                };

                displayUserStats(profileState.stats);
            } catch (error) {
                console.error('Failed to load user stats:', error);
                profileState.stats = null;
                hideLoading('user-stats-loading');
                showError('user-stats-error', 'profile.errors.userStats', { reason: error.message });
            }
        }

        function renderProfileHeader(user) {
            const container = document.getElementById('profile-user-info');
            if (!container) return;

            const name = [user.firstName, user.lastName].filter(Boolean).join(' ') || t('profile.values.notProvided');
            const role = translateRole(user.role);

            container.innerHTML = `
                <p>${t('profile.messages.welcome', { name })}</p>
                <p>${t('profile.messages.role', { role })}</p>
            `;
        }

        function displayUserInfo(user) {
            const container = document.getElementById('user-info');
            if (!container) return;

            hideLoading('user-info-loading');

            const fullName = [user.firstName, user.lastName].filter(Boolean).join(' ') || t('profile.values.notProvided');
            const email = user.email || t('profile.values.notProvided');
            const phone = user.phone || t('profile.values.notProvided');
            const role = translateRole(user.role);
            const registered = user.createdAt ? formatDate(user.createdAt) : t('profile.values.notProvided');
            const lastLogin = user.lastLogin ? formatDate(user.lastLogin) : t('profile.values.never');
            const address = formatAddress(user.address);

            const infoItems = [
                { label: t('profile.labels.name'), value: fullName },
                { label: t('profile.labels.email'), value: email },
                { label: t('profile.labels.phone'), value: phone },
                { label: t('profile.labels.role'), value: role },
                { label: t('profile.labels.registered'), value: registered },
                { label: t('profile.labels.lastLogin'), value: lastLogin },
                { label: t('profile.labels.address'), value: address }
            ];

            container.innerHTML = infoItems.map(item => `
                <div class="info-item">
                    <div class="info-label">${item.label}</div>
                    <div class="info-value">${item.value}</div>
                </div>
            `).join('');

            container.style.display = 'grid';
        }

        function displayUserStats(stats) {
            const container = document.getElementById('user-stats');
            if (!container) return;

            hideLoading('user-stats-loading');

            const wishlistValue = t('profile.stats.wishlistValue', { count: stats.totalWishlistItems });
            const memberSinceValue = stats.memberSince !== null
                ? t('profile.stats.memberSinceValue', { year: stats.memberSince })
                : t('profile.values.notProvided');

            const statsItems = [
                { label: t('profile.stats.orders'), value: stats.totalOrders },
                { label: t('profile.stats.spent'), value: formatCurrency(stats.totalSpent) },
                { label: t('profile.stats.wishlist'), value: wishlistValue },
                { label: t('profile.stats.memberSince'), value: memberSinceValue }
            ];

            container.innerHTML = statsItems.map(item => `
                <div class="info-item">
                    <div class="info-label">${item.label}</div>
                    <div class="info-value">${item.value}</div>
                </div>
            `).join('');

            container.style.display = 'grid';
        }

        function initializeProfileForm() {
            profileFormState.modal = document.getElementById('profile-modal');
            profileFormState.form = document.getElementById('profile-form');
            profileFormState.submitButton = document.getElementById('profile-form-submit');
            profileFormState.errorContainer = document.getElementById('profile-form-error');
            profileFormState.cancelButton = document.getElementById('profile-modal-cancel');

            if (!profileFormState.modal || !profileFormState.form) {
                return;
            }

            profileFormState.form.addEventListener('submit', handleProfileFormSubmit);

            if (profileFormState.cancelButton) {
                profileFormState.cancelButton.addEventListener('click', closeProfileModal);
            }

            profileFormState.modal.addEventListener('click', (event) => {
                if (event.target === profileFormState.modal) {
                    closeProfileModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && profileFormState.modal && !profileFormState.modal.hasAttribute('hidden')) {
                    closeProfileModal();
                }
            });
        }

        function updateBodyModalState() {
            const isOpen = profileFormState.modal && !profileFormState.modal.hasAttribute('hidden');
            document.body.classList.toggle('profile-modal-open', isOpen);
        }

        function openProfileModal(user) {
            if (!profileFormState.modal || !profileFormState.form) {
                return;
            }

            profileFormState.currentUser = user;
            if (profileFormState.errorContainer) {
                profileFormState.errorContainer.textContent = '';
            }

            fillProfileForm(user);

            profileFormState.modal.removeAttribute('hidden');
            updateBodyModalState();
            requestAnimationFrame(() => {
                profileFormState.modal.classList.add('is-open');
            });

            const firstField = profileFormState.form.querySelector('input:not([type="hidden"]):not([disabled])');
            if (firstField) {
                firstField.focus();
            }
        }

        function closeProfileModal() {
            if (!profileFormState.modal || !profileFormState.form) {
                return;
            }

            profileFormState.modal.classList.remove('is-open');
            setTimeout(() => {
                profileFormState.modal.setAttribute('hidden', '');
                updateBodyModalState();
            }, 150);

            profileFormState.form.reset();
            if (profileFormState.errorContainer) {
                profileFormState.errorContainer.textContent = '';
            }
            profileFormState.currentUser = null;
        }

        function fillProfileForm(user) {
            const form = profileFormState.form;
            if (!form) return;

            const address = user.address || {};

            form.elements['userId'].value = user.id ?? '';
            form.elements['firstName'].value = user.firstName ?? '';
            form.elements['lastName'].value = user.lastName ?? '';
            form.elements['email'].value = user.email ?? '';
            form.elements['phone'].value = user.phone ?? '';
            form.elements['street'].value = address.street ?? '';
            form.elements['city'].value = address.city ?? '';
            form.elements['state'].value = address.state ?? '';
            form.elements['zipCode'].value = address.zipCode ?? '';
            form.elements['country'].value = address.country ?? '';
            form.elements['password'].value = '';
        }

        function validateProfileForm() {
            if (!profileFormState.form) return { valid: false, message: t('profile.forms.validation.required') };

            const form = profileFormState.form;
            const firstName = form.elements['firstName'].value.trim();
            const lastName = form.elements['lastName'].value.trim();
            const email = form.elements['email'].value.trim();
            const newPassword = form.elements['password'].value.trim();

            if (!firstName || !lastName) {
                return { valid: false, message: t('profile.forms.validation.required') };
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return { valid: false, message: t('profile.forms.validation.email') };
            }

            if (newPassword && newPassword.length < 8) {
                return { valid: false, message: t('profile.forms.validation.password') };
            }

            return { valid: true, message: '' };
        }

        function getRememberPreference(authManager) {
            try {
                return !!localStorage.getItem(authManager.sessionKey);
            } catch (error) {
                return false;
            }
        }

        async function handleProfileFormSubmit(event) {
            event.preventDefault();

            const validation = validateProfileForm();
            if (!validation.valid) {
                if (profileFormState.errorContainer) {
                    profileFormState.errorContainer.textContent = validation.message;
                }
                return;
            }

            if (!profileState.user) {
                if (profileFormState.errorContainer) {
                    profileFormState.errorContainer.textContent = t('profile.errors.updateFailed', { reason: 'No user loaded' });
                }
                return;
            }

            const form = profileFormState.form;
            const formData = new FormData(form);
            const userId = formData.get('userId');

            const updatedUser = {
                ...profileState.user,
                firstName: formData.get('firstName').trim(),
                lastName: formData.get('lastName').trim(),
                email: formData.get('email').trim().toLowerCase(),
                phone: formData.get('phone').trim(),
                address: {
                    ...(profileState.user.address || {}),
                    street: formData.get('street').trim(),
                    city: formData.get('city').trim(),
                    state: formData.get('state').trim(),
                    zipCode: formData.get('zipCode').trim(),
                    country: formData.get('country').trim()
                }
            };

            const newPassword = formData.get('password').trim();
            if (newPassword) {
                updatedUser.password = newPassword;
            }

            const submitButton = profileFormState.submitButton;
            const originalButtonText = submitButton ? submitButton.textContent : '';

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Saving...';
            }
            if (profileFormState.errorContainer) {
                profileFormState.errorContainer.textContent = '';
            }

            try {
                const ApiClient = window.SneakerStoreAPI && window.SneakerStoreAPI.ApiClient;
                const authManager = window.SneakerStoreAuth && window.SneakerStoreAuth.authManager;

                if (!ApiClient || !authManager) {
                    throw new Error(t('profile.errors.apiUnavailable'));
                }

                const apiClient = new ApiClient();
                const response = await apiClient.put(`/users/${userId}`, updatedUser);

                if (!response.success) {
                    throw new Error(response.error || 'Unknown error');
                }

                const savedUser = response.data || updatedUser;

                profileState.user = savedUser;
                renderProfileHeader(savedUser);
                displayUserInfo(savedUser);

                authManager.currentUser = savedUser;
                const remember = getRememberPreference(authManager);
                authManager.saveSession(remember);
                if (typeof authManager.updateUI === 'function') {
                    authManager.updateUI();
                }

                closeProfileModal();
                alert(t('profile.alerts.updateSuccess'));
            } catch (error) {
                console.error('Failed to update profile:', error);
                if (profileFormState.errorContainer) {
                    profileFormState.errorContainer.textContent = t('profile.errors.updateFailed', { reason: error.message });
                }
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText || 'Save changes';
                }
            }
        }

        function formatAddress(address) {
            if (!address || typeof address !== 'object') {
                return t('profile.values.notProvided');
            }

            const parts = [
                address.street,
                address.city,
                address.state,
                address.zipCode,
                address.country
            ].filter(part => part && String(part).trim().length > 0);

            return parts.length > 0 ? parts.join(', ') : t('profile.values.notProvided');
        }

        function formatDate(value) {
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return t('profile.values.notProvided');
            }

            const language = window.I18n && typeof window.I18n.getCurrentLanguage === 'function'
                ? window.I18n.getCurrentLanguage()
                : 'en';

            const locale = language === 'ru' ? 'ru-RU' : 'en-US';

            try {
                return new Intl.DateTimeFormat(locale).format(date);
            } catch (error) {
                console.warn('Date formatting failed, falling back to ISO string.', error);
                return date.toISOString().split('T')[0];
            }
        }

        function formatCurrency(value) {
            const amount = Number(value) || 0;
            const language = window.I18n && typeof window.I18n.getCurrentLanguage === 'function'
                ? window.I18n.getCurrentLanguage()
                : 'en';
            const locale = language === 'ru' ? 'ru-RU' : 'en-US';

            try {
                return new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                }).format(amount);
            } catch (error) {
                console.warn('Currency formatting failed, falling back to USD string.', error);
                return `$${amount.toFixed(2)}`;
            }
        }

        function translateRole(role) {
            const normalized = (role || 'unknown').toLowerCase();
            const key = `profile.roles.${normalized}`;
            const translation = t(key);
            if (translation === key) {
                return normalized.charAt(0).toUpperCase() + normalized.slice(1);
            }
            return translation;
        }

        function showLoading(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
            }
        }

        function hideLoading(id) {
            hideElement(id);
        }

        function hideElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
            }
        }

        function hideError(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
                element.textContent = '';
            }
        }

        function showError(id, key, replacements = {}) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = t(key, replacements);
                element.style.display = 'block';
            }
        }

        function renderProfile() {
            if (profileState.user) {
                renderProfileHeader(profileState.user);
                displayUserInfo(profileState.user);
            }
            if (profileState.stats) {
                displayUserStats(profileState.stats);
            }
        }

        function editProfile() {
            if (profileState.user) {
                openProfileModal(profileState.user);
            }
        }

        function viewOrders() {
            alert(t('profile.alerts.orders'));
        }

        function viewWishlist() {
            alert(t('profile.alerts.wishlist'));
        }

        function logout() {
            if (window.SneakerStoreAuth && window.SneakerStoreAuth.authManager) {
                window.SneakerStoreAuth.authManager.logout();
            }
        }
    </script>
</body>
</html>
