<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/styles.css">
    <title>Sneaker Store - –ú–æ–∏ –∑–∞–∫–∞–∑—ã</title>
    <style>
        .orders-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 70vh;
        }
        
        .orders-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .orders-header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
        }
        
        .orders-header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin: 0;
        }
        
        .orders-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid var(--color-accent);
            background: transparent;
            color: var(--color-light);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: var(--color-accent);
            color: white;
        }
        
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .order-card {
            background: rgba(255, 255, 255, 0.05);
            border: var(--border);
            border-radius: var(--border-radius);
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .order-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .order-number {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--color-light);
        }
        
        .order-date {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
        }
        
        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #ffc107;
            color: #000;
        }
        
        .status-processing {
            background: #17a2b8;
            color: white;
        }
        
        .status-shipped {
            background: #007bff;
            color: white;
        }
        
        .status-delivered {
            background: #28a745;
            color: white;
        }
        
        .status-cancelled {
            background: #dc3545;
            color: white;
        }
        
        .order-items {
            margin: 20px 0;
        }
        
        .order-items-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--color-light);
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .item-name {
            font-weight: 600;
            color: var(--color-light);
        }
        
        .item-info {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .item-price {
            font-weight: 600;
            color: var(--color-accent);
        }
        
        .order-summary {
            display: flex;
            justify-content: flex-end;
            gap: 30px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .summary-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
        }
        
        .summary-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-accent);
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-details {
            background: var(--color-accent);
            color: white;
        }
        
        .btn-details:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-reorder {
            background: transparent;
            color: var(--color-light);
            border: 2px solid var(--color-accent);
        }
        
        .btn-reorder:hover {
            background: var(--color-accent);
        }
        
        .empty-orders {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-orders-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-orders h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
            color: var(--color-light);
        }
        
        .empty-orders p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
        }
        
        .empty-orders-btn {
            display: inline-block;
            padding: 15px 40px;
            background: var(--color-accent);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .empty-orders-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-light);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(220, 53, 69, 0.1);
            color: #ff6b6b;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(220, 53, 69, 0.3);
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .orders-container {
                padding: 10px;
            }
            
            .orders-header {
                padding: 30px 20px;
            }
            
            .orders-header h1 {
                font-size: 2em;
            }
            
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .order-summary {
                flex-direction: column;
                gap: 15px;
                align-items: flex-end;
            }
            
            .order-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div data-include="header"></div>

    <main class="content">
        <div class="orders-container">
            <div class="orders-header">
                <h1>üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>
                <p id="user-info">–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø–æ–∫—É–ø–æ–∫</p>
            </div>

            <div class="orders-filter" id="orders-filter">
                <button class="filter-btn active" data-filter="all">–í—Å–µ –∑–∞–∫–∞–∑—ã</button>
                <button class="filter-btn" data-filter="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</button>
                <button class="filter-btn" data-filter="processing">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</button>
                <button class="filter-btn" data-filter="shipped">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
                <button class="filter-btn" data-filter="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</button>
            </div>

            <div id="orders-loading" class="loading">
                <div class="loading-spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
            </div>

            <div id="orders-error" class="error" style="display: none;"></div>

            <div id="orders-list" class="orders-list" style="display: none;">
                <!-- –ó–∞–∫–∞–∑—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </main>

    <div data-include="footer"></div>

    <script src="./scripts/partials.js"></script>
    <script src="./scripts/api.js"></script>
    <script src="./scripts/auth.js"></script>
    <script src="./scripts/preloader.js"></script>
    <script src="./scripts/accessibility.js"></script>
    
    <script>
        let allOrders = [];
        let currentFilter = 'all';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            if (!window.SneakerStoreAuth || !window.SneakerStoreAuth.authManager.isAuthenticated()) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–æ–≤');
                window.location.href = 'login.html';
                return;
            }

            const user = window.SneakerStoreAuth.authManager.getCurrentUser();
            document.getElementById('user-info').textContent = `–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫: ${user.firstName} ${user.lastName}`;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
            await loadOrders();

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            setupFilters();
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            if (window.SneakerStorePreloader && window.SneakerStorePreloader.preloader) {
                await window.SneakerStorePreloader.preloader.stop();
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤
        async function loadOrders() {
            try {
                const user = window.SneakerStoreAuth.authManager.getCurrentUser();
                
                // –î–µ–ª–∞–µ–º –ø—Ä—è–º–æ–π fetch –∑–∞–ø—Ä–æ—Å
                const response = await fetch(`http://localhost:3000/orders?userId=${user.id}`);
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                const text = await response.text();
                console.log('Response text:', text);
                console.log('Response text length:', text.length);
                
                // –¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
                const data = text ? JSON.parse(text) : [];
                console.log('Orders data:', data);
                
                allOrders = data || [];
                console.log('Orders loaded:', allOrders);
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                if (allOrders.length > 0) {
                    allOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                }
                
                displayOrders(allOrders);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤: ' + error.message);
            } finally {
                document.getElementById('orders-loading').style.display = 'none';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
        function displayOrders(orders) {
            const container = document.getElementById('orders-list');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-orders">
                        <div class="empty-orders-icon">üì¶</div>
                        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</h3>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –¥–µ–ª–∞—Ç—å –ø–æ–∫—É–ø–∫–∏ –≤ –Ω–∞—à–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ!</p>
                        <a href="catalog.html" class="empty-orders-btn">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
                    </div>
                `;
            } else {
                container.innerHTML = orders.map(order => createOrderCard(order)).join('');
            }
            
            container.style.display = 'block';
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–∞
        function createOrderCard(order) {
            const statusClass = `status-${order.status}`;
            const statusText = getStatusText(order.status);
            const orderDate = new Date(order.createdAt).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-info">
                            <div class="order-number">–ó–∞–∫–∞–∑ #${order.id}</div>
                            <div class="order-date">${orderDate}</div>
                        </div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>

                    <div class="order-items">
                        <div class="order-items-title">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</div>
                        ${order.items.map(item => `
                            <div class="order-item">
                                <div class="item-details">
                                    <div class="item-name">${item.productName}</div>
                                    <div class="item-info">
                                        ${item.brand} ‚Ä¢ –†–∞–∑–º–µ—Ä: ${item.size} ‚Ä¢ –¶–≤–µ—Ç: ${item.color} ‚Ä¢ –ö–æ–ª-–≤–æ: ${item.quantity}
                                    </div>
                                </div>
                                <div class="item-price">$${item.subtotal.toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="order-summary">
                        <div class="summary-item">
                            <div class="summary-label">–ü–æ–¥—ã—Ç–æ–≥</div>
                            <div class="summary-value">$${order.subtotal.toFixed(2)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">–ù–∞–ª–æ–≥</div>
                            <div class="summary-value">$${order.tax.toFixed(2)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">–î–æ—Å—Ç–∞–≤–∫–∞</div>
                            <div class="summary-value">${order.shipping === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : '$' + order.shipping.toFixed(2)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">–ò—Ç–æ–≥–æ</div>
                            <div class="summary-value" style="font-size: 1.5em;">$${order.total.toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="order-actions">
                        <button class="btn btn-details" onclick="showOrderDetails('${order.id}')">
                            –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
                        </button>
                        <button class="btn btn-reorder" onclick="reorder('${order.id}')">
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    </div>
                </div>
            `;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
        function getStatusText(status) {
            const statusTexts = {
                'pending': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                'processing': '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è',
                'shipped': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
            };
            return statusTexts[status] || status;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function setupFilters() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    filterButtons.forEach(b => b.classList.remove('active'));
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –Ω–∞ –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É
                    btn.classList.add('active');
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
                    const filter = btn.getAttribute('data-filter');
                    currentFilter = filter;
                    applyFilter(filter);
                });
            });
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
        function applyFilter(filter) {
            let filteredOrders = allOrders;
            
            if (filter !== 'all') {
                filteredOrders = allOrders.filter(order => order.status === filter);
            }
            
            displayOrders(filteredOrders);
        }

        // –ü–æ–∫–∞–∑ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
        function showOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            alert(`
–ó–∞–∫–∞–∑ #${order.id}

–°—Ç–∞—Ç—É—Å: ${getStatusText(order.status)}
–î–∞—Ç–∞: ${new Date(order.createdAt).toLocaleDateString('ru-RU')}

–ü–æ–ª—É—á–∞—Ç–µ–ª—å:
${order.customerInfo.firstName} ${order.customerInfo.lastName}
Email: ${order.customerInfo.email}
–¢–µ–ª–µ—Ñ–æ–Ω: ${order.customerInfo.phone}

–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:
${order.customerInfo.address.street}
${order.customerInfo.address.city}, ${order.customerInfo.address.zipCode}
${order.customerInfo.address.country}

–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: ${order.paymentMethod}
            `);
        }

        // –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑
        async function reorder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            if (confirm(`–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∑–∞–∫–∞–∑–∞ #${order.id} –≤ –∫–æ—Ä–∑–∏–Ω—É?`)) {
                try {
                    const cartManager = window.SneakerStoreCart?.cartManager;
                    if (!cartManager) {
                        throw new Error('–ö–æ—Ä–∑–∏–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
                    for (const item of order.items) {
                        await cartManager.addItem(
                            item.productId,
                            item.size,
                            item.color,
                            item.quantity
                        );
                    }

                    alert('–¢–æ–≤–∞—Ä—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–æ—Ä–∑–∏–Ω—É!');
                    window.location.href = 'cart.html';
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ –∑–∞–∫–∞–∑–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É: ' + error.message);
                }
            }
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorElement = document.getElementById('orders-error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    </script>
</body>
</html>

