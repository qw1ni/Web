<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/styles.css">
    <title>Sneaker Store - My Orders</title>
    <style>
        .orders-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 70vh;
        }
        
        .orders-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .orders-header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
        }
        
        .orders-header p {
            font-size: 1.1em;
            opacity: 0.9;
            margin: 0;
        }
        
        .orders-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid var(--color-accent);
            background: transparent;
            color: var(--color-light);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: var(--color-accent);
            color: white;
        }
        
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .order-card {
            background: rgba(255, 255, 255, 0.05);
            border: var(--border);
            border-radius: var(--border-radius);
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .order-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .order-number {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--color-light);
        }
        
        .order-date {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
        }
        
        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #ffc107;
            color: #000;
        }
        
        .status-processing {
            background: #17a2b8;
            color: white;
        }
        
        .status-shipped {
            background: #007bff;
            color: white;
        }
        
        .status-delivered {
            background: #28a745;
            color: white;
        }
        
        .status-cancelled {
            background: #dc3545;
            color: white;
        }
        
        .order-items {
            margin: 20px 0;
        }
        
        .order-items-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--color-light);
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .item-name {
            font-weight: 600;
            color: var(--color-light);
        }
        
        .item-info {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .item-price {
            font-weight: 600;
            color: var(--color-accent);
        }
        
        .order-summary {
            display: flex;
            justify-content: flex-end;
            gap: 30px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .summary-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
        }
        
        .summary-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-accent);
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-details {
            background: var(--color-accent);
            color: white;
        }
        
        .btn-details:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-reorder {
            background: transparent;
            color: var(--color-light);
            border: 2px solid var(--color-accent);
        }
        
        .btn-reorder:hover {
            background: var(--color-accent);
        }
        
        .empty-orders {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-orders-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-orders h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
            color: var(--color-light);
        }
        
        .empty-orders p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
        }
        
        .empty-orders-btn {
            display: inline-block;
            padding: 15px 40px;
            background: var(--color-accent);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .empty-orders-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-light);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(220, 53, 69, 0.1);
            color: #ff6b6b;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(220, 53, 69, 0.3);
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .orders-container {
                padding: 10px;
            }
            
            .orders-header {
                padding: 30px 20px;
            }
            
            .orders-header h1 {
                font-size: 2em;
            }
            
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .order-summary {
                flex-direction: column;
                gap: 15px;
                align-items: flex-end;
            }
            
            .order-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div data-include="header"></div>

    <main class="content">
        <div class="orders-container">
            <div class="orders-header">
                <h1 data-i18n="orders.page.title">ðŸ“¦ My Orders</h1>
                <p id="user-info" data-i18n="orders.page.subtitle">Your purchase history</p>
            </div>

            <div class="orders-filter" id="orders-filter">
                <button class="filter-btn active" data-filter="all" data-i18n="orders.filters.all">All orders</button>
                <button class="filter-btn" data-filter="pending" data-i18n="orders.filters.pending">Pending</button>
                <button class="filter-btn" data-filter="processing" data-i18n="orders.filters.processing">Processing</button>
                <button class="filter-btn" data-filter="shipped" data-i18n="orders.filters.shipped">Shipped</button>
                <button class="filter-btn" data-filter="delivered" data-i18n="orders.filters.delivered">Delivered</button>
            </div>

            <div id="orders-loading" class="loading">
                <div class="loading-spinner"></div>
                <p data-i18n="orders.loading">Loading your orders...</p>
            </div>

            <div id="orders-error" class="error" style="display: none;"></div>

            <div id="orders-list" class="orders-list" style="display: none;">
                <!-- Orders will be added dynamically -->
            </div>
        </div>
    </main>

    <div data-include="footer"></div>

    <script src="./scripts/partials.js"></script>
    <script src="./scripts/i18n.js"></script>
    <script src="./scripts/api.js"></script>
    <script src="./scripts/auth.js"></script>
    <script src="./scripts/preloader.js"></script>
    <script src="./scripts/accessibility.js"></script>
    
    <script>
        const ordersFallbacks = {
            'orders.page.subtitle': 'Your purchase history',
            'orders.alerts.authRequired': 'You must be signed in to view orders.',
            'orders.messages.history': 'Order history: {name}',
            'orders.loading': 'Loading your orders...',
            'orders.errors.load': 'Failed to load orders: {reason}',
            'orders.errors.none': 'You do not have any orders yet.',
            'orders.empty.title': 'You do not have any orders yet',
            'orders.empty.text': 'Start shopping in our catalog!',
            'orders.empty.button': 'Browse catalog',
            'orders.orderNumber': 'Order #{id}',
            'orders.date': 'Placed on {date}',
            'orders.status.pending': 'Pending',
            'orders.status.processing': 'Processing',
            'orders.status.shipped': 'Shipped',
            'orders.status.delivered': 'Delivered',
            'orders.status.cancelled': 'Cancelled',
            'orders.items.title': 'Order items',
            'orders.item.details': '{brand} â€¢ Size: {size} â€¢ Color: {color} â€¢ Qty: {quantity}',
            'orders.summary.subtotal': 'Subtotal',
            'orders.summary.tax': 'Tax',
            'orders.summary.shipping': 'Shipping',
            'orders.summary.total': 'Total',
            'orders.buttons.details': 'View details',
            'orders.buttons.reorder': 'Reorder',
            'orders.modal.reorder': 'Add all items from order #{id} to your cart?',
            'orders.messages.reorderSuccess': 'Items added to your cart!',
            'orders.errors.reorderUnavailable': 'Cart is unavailable.',
            'orders.errors.reorderFailed': 'Failed to reorder items: {reason}',
            'orders.details.title': 'Order #{id}',
            'orders.details.status': 'Status: {status}',
            'orders.details.date': 'Date: {date}',
            'orders.details.recipient': 'Recipient:',
            'orders.details.contact': 'Email: {email}\nPhone: {phone}',
            'orders.details.address': 'Shipping address:',
            'orders.details.payment': 'Payment method: {method}'
        };

        function t(key, replacements = {}) {
            const translateFn = window.I18n && typeof window.I18n.translate === 'function'
                ? window.I18n.translate
                : () => key;
            let result = translateFn(key);
            if (result === key && ordersFallbacks[key]) {
                result = ordersFallbacks[key];
            }
            result = String(result);
            Object.entries(replacements).forEach(([placeholder, value]) => {
                result = result.replace(`{${placeholder}}`, value);
            });
            return result;
        }

        const ordersState = {
            allOrders: [],
            currentFilter: 'all'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            if (!window.SneakerStoreAuth || !window.SneakerStoreAuth.authManager?.isAuthenticated()) {
                alert(t('orders.alerts.authRequired'));
                window.location.href = 'login.html';
                return;
            }

            await initializeOrdersPage();
        });

        document.addEventListener('languageChanged', () => {
            renderOrders();
            updateUserHeading();
            resetFilterLabels();
        });

        async function initializeOrdersPage() {
            updateUserHeading();
            await loadOrders();
            setupFilters();

            if (window.SneakerStorePreloader?.preloader) {
                try {
                    await window.SneakerStorePreloader.preloader.stop();
                } catch (error) {
                    console.warn('Failed to stop preloader:', error);
                }
            }
        }

        function updateUserHeading() {
            const heading = document.getElementById('user-info');
            if (!heading) return;

            const user = window.SneakerStoreAuth?.authManager?.getCurrentUser();
            if (!user) return;

            const name = [user.firstName, user.lastName].filter(Boolean).join(' ');
            heading.textContent = t('orders.messages.history', { name });
        }

        function resetFilterLabels() {
            const filters = document.querySelectorAll('.filter-btn');
            filters.forEach(btn => {
                const key = btn.getAttribute('data-i18n');
                if (key) {
                    btn.textContent = t(key);
                }
            });
        }

        async function loadOrders() {
            const loading = document.getElementById('orders-loading');
            const errorElement = document.getElementById('orders-error');

            if (loading) loading.style.display = 'block';
            if (errorElement) errorElement.style.display = 'none';

            try {
                const user = window.SneakerStoreAuth.authManager.getCurrentUser();
                const response = await fetch(`http://localhost:3000/orders?userId=${user.id}`);

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const text = await response.text();
                const data = text ? JSON.parse(text) : [];

                ordersState.allOrders = Array.isArray(data) ? data : [];
                ordersState.allOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                renderOrders();
            } catch (error) {
                console.error('Failed to load orders:', error);
                showError(t('orders.errors.load', { reason: error.message }));
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        function renderOrders() {
            const container = document.getElementById('orders-list');
            if (!container) return;

            let filteredOrders = ordersState.allOrders;
            if (ordersState.currentFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === ordersState.currentFilter);
            }

            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-orders">
                        <div class="empty-orders-icon">ðŸ“¦</div>
                        <h3>${t('orders.empty.title')}</h3>
                        <p>${t('orders.empty.text')}</p>
                        <a href="catalog.html" class="empty-orders-btn">${t('orders.empty.button')}</a>
                    </div>
                `;
            } else {
                container.innerHTML = filteredOrders.map(createOrderCard).join('');
            }

            container.style.display = 'block';
        }

        function createOrderCard(order) {
            const statusClass = `status-${order.status}`;
            const statusText = t(`orders.status.${order.status}`);
            const date = formatDate(order.createdAt);

            const itemsHtml = (order.items || []).map(item => {
                const details = t('orders.item.details', {
                    brand: item.brand || '',
                    size: item.size,
                    color: item.color,
                    quantity: item.quantity
                });

                return `
                    <div class="order-item">
                        <div class="item-details">
                            <div class="item-name">${item.productName}</div>
                            <div class="item-info">${details}</div>
                        </div>
                        <div class="item-price">${formatCurrency(item.subtotal)}</div>
                    </div>
                `;
            }).join('');

            const shippingValue = order.shipping === 0 ? t('cart.summary.free') || 'Free' : formatCurrency(order.shipping);

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-info">
                            <div class="order-number">${t('orders.orderNumber', { id: order.id })}</div>
                            <div class="order-date">${t('orders.date', { date })}</div>
                        </div>
                        <div class="order-status ${statusClass}">${statusText}</div>
                    </div>

                    <div class="order-items">
                        <div class="order-items-title">${t('orders.items.title')}</div>
                        ${itemsHtml}
                    </div>

                    <div class="order-summary">
                        <div class="summary-item">
                            <div class="summary-label">${t('orders.summary.subtotal')}</div>
                            <div class="summary-value">${formatCurrency(order.subtotal)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">${t('orders.summary.tax')}</div>
                            <div class="summary-value">${formatCurrency(order.tax)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">${t('orders.summary.shipping')}</div>
                            <div class="summary-value">${shippingValue}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">${t('orders.summary.total')}</div>
                            <div class="summary-value" style="font-size: 1.5em;">${formatCurrency(order.total)}</div>
                        </div>
                    </div>

                    <div class="order-actions">
                        <button class="btn btn-details" onclick="showOrderDetails('${order.id}')">${t('orders.buttons.details')}</button>
                        <button class="btn btn-reorder" onclick="reorder('${order.id}')">${t('orders.buttons.reorder')}</button>
                    </div>
                </div>
            `;
        }

        function formatDate(value) {
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;

            const language = window.I18n?.getCurrentLanguage?.() || 'en';
            const locale = language === 'ru' ? 'ru-RU' : 'en-US';

            try {
                return new Intl.DateTimeFormat(locale, {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(date);
            } catch {
                return date.toISOString().split('T')[0];
            }
        }

        function formatCurrency(value) {
            const amount = Number(value) || 0;
            const language = window.I18n?.getCurrentLanguage?.() || 'en';
            const locale = language === 'ru' ? 'ru-RU' : 'en-US';

            try {
                return new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                }).format(amount);
            } catch {
                return `$${amount.toFixed(2)}`;
            }
        }

        function setupFilters() {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    ordersState.currentFilter = btn.getAttribute('data-filter') || 'all';
                    renderOrders();
                });
            });
        }

        function showOrderDetails(orderId) {
            const order = ordersState.allOrders.find(o => o.id === orderId);
            if (!order) return;

            const language = window.I18n?.getCurrentLanguage?.() || 'en';
            const date = formatDate(order.createdAt);
            const status = t(`orders.status.${order.status}`);

            const addressParts = [
                order.customerInfo.address.street,
                [order.customerInfo.address.city, order.customerInfo.address.zipCode].filter(Boolean).join(', '),
                order.customerInfo.address.country
            ].filter(Boolean).join('\n');

            const message = `
${t('orders.details.title', { id: order.id })}

${t('orders.details.status', { status })}
${t('orders.details.date', { date })}

${t('orders.details.recipient')}
${order.customerInfo.firstName} ${order.customerInfo.lastName}
${t('orders.details.contact', { email: order.customerInfo.email, phone: order.customerInfo.phone || '-' })}

${t('orders.details.address')}
${addressParts}

${t('orders.details.payment', { method: order.paymentMethod || '-' })}
            `;

            alert(message.trim());
        }

        async function reorder(orderId) {
            const order = ordersState.allOrders.find(o => o.id === orderId);
            if (!order) return;

            if (!confirm(t('orders.modal.reorder', { id: order.id }))) {
                return;
            }

            try {
                const cartManager = window.SneakerStoreCart?.cartManager;
                if (!cartManager) {
                    throw new Error(t('orders.errors.reorderUnavailable'));
                }

                for (const item of order.items) {
                    await cartManager.addItem(item.productId, item.size, item.color, item.quantity);
                }

                alert(t('orders.messages.reorderSuccess'));
                window.location.href = 'cart.html';
            } catch (error) {
                console.error('Failed to reorder:', error);
                alert(t('orders.errors.reorderFailed', { reason: error.message }));
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('orders-error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
    </script>
</body>
</html>

